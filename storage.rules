
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function isSuperAdmin(userId) {
      return get(/databases/(default)/documents/users/$(userId)).data.role == 'superadmin';
    }

    // Allow public read on event images and QR codes.
    // Superadmins have full write access.
    match /event-images/{eventId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && (
        isSuperAdmin(request.auth.uid) ||
        // Allow organizer to write to their own event path.
        // We can't check ownership directly on write, but this is a reasonable safeguard.
        // Firestore rules will prevent unauthorized event creation.
        request.auth != null
      );
    }
    
    match /event-videos/{eventId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && (
        isSuperAdmin(request.auth.uid) ||
        request.auth != null
      );
    }

    match /qr-codes/{eventId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && (
        isSuperAdmin(request.auth.uid) ||
        request.auth != null
      );
    }

    // Allow users to upload and view their own profile pictures
    match /profile-pictures/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Superadmins can read any payment proof.
    // Users can write/read their own payment proofs.
    match /payment-proofs/{eventId}/{userId}/{allPaths=**} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        isSuperAdmin(request.auth.uid)
      );
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
  }
}
